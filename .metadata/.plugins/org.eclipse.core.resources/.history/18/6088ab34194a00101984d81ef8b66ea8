package test0905;

import java.time.Duration;
import java.util.List;

import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import io.github.bonigarcia.wdm.WebDriverManager;

public class SeventhTestCase {
	public static void main(String[] args) {
		WebDriverManager.chromedriver().setup();
		ChromeOptions options = new ChromeOptions();
		options.addArguments("--incognito");
		WebDriver driver = new ChromeDriver(options);

		WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));

		try {
			driver.get("https://www.skillmuni.in/Skillmuni_Prod/login");
			driver.manage().window().maximize();
			System.out.println("Title => " + driver.getTitle());
			System.out.println("URL => " + driver.getCurrentUrl());

			// Login
			wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("userId"))).sendKeys("healthApp");
			driver.findElement(By.id("password")).sendKeys("healthApp");
			driver.findElement(By.xpath("//button[@class='login-btn']")).click();

			// Go to Knowledge Knook -> See All
			wait.until(ExpectedConditions.elementToBeClickable(By.xpath("//a[@href='/Skillmuni_Prod/learning-zone']")))
					.click();
			System.out.println("Clicked Knowledge Knook -> See All");

			// Find all topic cards
			wait.until(ExpectedConditions
					.presenceOfElementLocated(By.xpath("//div[contains(@class,'play-card-content')]")));
			List<WebElement> cards = driver.findElements(By.xpath("//div[contains(@class,'play-card-content')]"));
			System.out.println("üìö Total topic cards found: " + cards.size());

			for (int i = 0; i < cards.size(); i++) {
				cards = driver.findElements(By.xpath("//div[contains(@class,'play-card-content')]")); // Re-fetch
				if (i >= cards.size())
					continue;

				WebElement card = cards.get(i);
				System.out.println("‚û°Ô∏è Clicking on card #" + (i + 1));
				card.click();

				try {
					// Wait for Let's Go button and click
					WebElement letsGoBtn = wait.until(ExpectedConditions
							.elementToBeClickable(By.xpath("//button[contains(text(),\"Let's Go\")]")));
					System.out.println("üìù Pre-assessment screen detected. Clicking 'Let's Go!'");
					letsGoBtn.click();

					// Wait for question screen
					wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//div[@class='question-text']")));
					List<WebElement> questions = driver.findElements(By.xpath("//div[@class='question-text']"));
					System.out.println("‚ùì Total questions found: " + questions.size());

					int questionsToAnswer = Math.min(2, questions.size()); // answer 2 questions

					// Answer first few questions
					for (int q = 0; q < questionsToAnswer; q++) {
						WebElement question = questions.get(q);
						WebElement firstOption = question
								.findElement(By.xpath(".//input[@type='radio']"));
						firstOption.click();
						System.out.println("‚úÖ Answered question #" + (q + 1));
						Thread.sleep(500);
					}

					// Click Back button
					System.out.println("üîô Clicking Back after answering " + questionsToAnswer + " question(s)");
					WebElement backBtn = wait
							.until(ExpectedConditions.elementToBeClickable(By.xpath("//img[@alt='Back Icon']")));
					backBtn.click();

					// Check for break modal
					try {
						wait.until(ExpectedConditions.visibilityOfElementLocated(
								By.xpath("//h2[contains(text(),'Break Time? A Head‚Äôs Up')]")));
						WebElement yesBtn = driver.findElement(By.xpath("//button[text()='YES']"));
						System.out.println("‚ö†Ô∏è Break warning detected. Clicking 'YES' to exit.");
						yesBtn.click();
					} catch (Exception modalNotFound) {
						System.out.println("‚ùå Break warning modal did NOT appear.");
						driver.navigate().back();
					}

					// üìä After assessment, detect skill level and credits
					Thread.sleep(2000); // Wait for results
					detectSkillLevelAndCredits(driver, wait);

				} catch (Exception e) {
					System.out.println("‚úÖ No pre-assessment found or already completed for this card.");
					driver.navigate().back();
				}
				Thread.sleep(2000);
			}

		} catch (Exception e) {
			System.out.println("üö´ Error occurred: " + e.getMessage());
		} finally {
			driver.quit();
		}
	}

	public static void detectSkillLevelAndCredits(WebDriver driver, WebDriverWait wait) {
		try {
			// Wait for credits and skill level to be visible
			wait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath("//*[contains(text(),'Credits') and contains(text(),'Earned')]")));
			WebElement creditElement = driver.findElement(By.xpath("//*[contains(text(),'Credits') and contains(text(),'Earned')]"));
			System.out.println("üéØ Credits Earned: " + creditElement.getText());

			WebElement skillLevelElement = driver.findElement(
					By.xpath("//*[contains(text(),'You‚Äôre at the') or contains(@class, 'skillLevelText')]"));
			String skillText = skillLevelElement.getText();

			if (skillText.contains("Beginner")) {
				System.out.println("üß† Skill Level Detected: Beginner");
			} else if (skillText.contains("Intermediate")) {
				System.out.println("üß† Skill Level Detected: Intermediate");
			} else if (skillText.contains("Advanced")) {
				System.out.println("üß† Skill Level Detected: Advanced");
			} else {
				System.out.println("üß† Skill Level: Unknown");
			}

			// Optional: Start Stage
			WebElement startBtn = driver.findElement(By.xpath("//button[contains(text(),'Start Stage')]"));
			startBtn.click();
			System.out.println("‚ñ∂Ô∏è Clicked Start Stage");

		} catch (Exception e) {
			System.out.println("‚ùå Skill/Credits not found or skipped: " + e.getMessage());
		}
	}
}
